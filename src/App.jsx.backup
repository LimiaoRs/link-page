import { useState, useEffect } from "react";
import './App.css';
import Auth from './Auth';
import ProfileEditor from './ProfileEditor';
import LinkManager from './LinkManager';
import AvatarUploader from './AvatarUploader';
import { auth, database } from './supabase';
import ThemeToggle from './ThemeToggle';

export default function App() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [links, setLinks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isEditMode, setIsEditMode] = useState(false);
  const [showProfileEditor, setShowProfileEditor] = useState(false);
  const [showLinkManager, setShowLinkManager] = useState(false);
  const [showAvatarUploader, setShowAvatarUploader] = useState(false);
  const [currentStatus, setCurrentStatus] = useState({ emoji: 'ğŸ’¼', text: 'å·¥ä½œä¸­' });

  // çŠ¶æ€é€‰é¡¹
  const statusOptions = [
    { emoji: 'ğŸ’¼', text: 'å·¥ä½œä¸­' },
    { emoji: 'ğŸ“š', text: 'å­¦ä¹ ä¸­' },
    { emoji: 'ğŸ˜´', text: 'ç¡è§‰ä¸­' },
    { emoji: 'ğŸ®', text: 'æ¸¸æˆä¸­' },
    { emoji: 'ğŸƒ', text: 'è¿åŠ¨ä¸­' },
    { emoji: 'ğŸ•', text: 'ç”¨é¤ä¸­' },
    { emoji: 'ğŸš—', text: 'é€šå‹¤ä¸­' },
    { emoji: 'ğŸµ', text: 'å¬éŸ³ä¹' },
    { emoji: 'ğŸ“º', text: 'çœ‹å‰§ä¸­' },
    { emoji: 'â˜•', text: 'ä¼‘æ¯ä¸­' },
    { emoji: 'ğŸ”¥', text: 'å¿™ç¢Œä¸­' },
    { emoji: 'ğŸ˜Š', text: 'å¼€å¿ƒä¸­' },
    { emoji: 'ğŸ’•', text: 'æ‹çˆ±ä¸­' },
    { emoji: 'ğŸ†“', text: 'å•èº«ä¸­' },
    { emoji: 'ğŸ¯', text: 'ä¸“æ³¨ä¸­' },
    { emoji: 'ğŸŒŸ', text: 'æœ‰ç©ºèŠ' },
  ];

  // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
  useEffect(() => {
    const checkAuth = async () => {
      console.log('=== å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€ ===');
      
      try {
        console.log('æ­¥éª¤1: è°ƒç”¨ auth.getCurrentUser()');
        const { data: { user } } = await auth.getCurrentUser();
        console.log('æ­¥éª¤2: è·å–åˆ°ç”¨æˆ·æ•°æ®:', user);
        
        if (user) {
          console.log('æ­¥éª¤3: ç”¨æˆ·å·²ç™»å½•ï¼Œè®¾ç½®ç”¨æˆ·çŠ¶æ€');
          setUser(user);
          
          console.log('æ­¥éª¤4: å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ®');
          await loadUserData(user.id);
          console.log('æ­¥éª¤5: ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ');
        } else {
          console.log('æ­¥éª¤3: ç”¨æˆ·æœªç™»å½•');
        }
      } catch (error) {
        console.error('è®¤è¯æ£€æŸ¥å‡ºé”™:', error);
      } finally {
        console.log('æ­¥éª¤6: è®¾ç½® loading ä¸º false');
        setLoading(false);
      }
    };

    checkAuth();
  }, []);

  // åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆåŒ…æ‹¬èµ„æ–™å’Œé“¾æ¥ï¼‰
  const loadUserData = async (userId) => {
    console.log('å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', userId);
    
    try {
      // åŠ è½½ç”¨æˆ·èµ„æ–™
      console.log('æ­£åœ¨åŠ è½½ç”¨æˆ·èµ„æ–™...');
      const { data: profileData, error: profileError } = await database.getProfile(userId);
      console.log('ç”¨æˆ·èµ„æ–™æŸ¥è¯¢ç»“æœ:', { profileData, profileError });
      
      if (profileError && profileError.code === 'PGRST116') {
        console.log('ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤èµ„æ–™');
        // ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
        const newProfile = {
          id: userId,
          username: user?.user_metadata?.username || user?.email?.split('@')[0] || 'user_' + userId.slice(0, 8),
          display_name: user?.user_metadata?.display_name || user?.email?.split('@')[0] || 'æ–°ç”¨æˆ·',
          bio: 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™...',
          avatar_url: '',
          current_status_emoji: 'ğŸ’¼',
          current_status_text: 'å·¥ä½œä¸­'
        };
        
        const { data: createdProfile, error: createError } = await database.createProfile(newProfile);
        if (createError) {
          console.error('åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥:', createError);
          setProfile(newProfile); // ä½¿ç”¨æœ¬åœ°æ•°æ®
        } else {
          console.log('ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ:', createdProfile);
          setProfile(createdProfile[0]);
        }
        
        setCurrentStatus({
          emoji: newProfile.current_status_emoji,
          text: newProfile.current_status_text
        });
      } else if (profileData) {
        console.log('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ');
        setProfile(profileData);
        setCurrentStatus({
          emoji: profileData.current_status_emoji || 'ğŸ’¼',
          text: profileData.current_status_text || 'å·¥ä½œä¸­'
        });
      }

      // åŠ è½½ç”¨æˆ·é“¾æ¥
      console.log('æ­£åœ¨åŠ è½½ç”¨æˆ·é“¾æ¥...');
      const { data: linksData, error: linksError } = await database.getLinks(userId);
      console.log('ç”¨æˆ·é“¾æ¥æŸ¥è¯¢ç»“æœ:', { linksData, linksError });
      
      if (linksError) {
        console.error('åŠ è½½é“¾æ¥å¤±è´¥:', linksError);
        setLinks([]); // è®¾ä¸ºç©ºæ•°ç»„
      } else {
        console.log('é“¾æ¥åŠ è½½æˆåŠŸï¼Œæ•°é‡:', linksData?.length || 0);
        setLinks(linksData || []);
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
      // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤æ•°æ®
      const defaultProfile = {
        id: userId,
        username: user?.user_metadata?.username || user?.email?.split('@')[0] || 'user_' + userId.slice(0, 8),
        display_name: user?.user_metadata?.display_name || user?.email?.split('@')[0] || 'æ–°ç”¨æˆ·',
        bio: 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™...',
        avatar_url: '',
        current_status_emoji: 'ğŸ’¼',
        current_status_text: 'å·¥ä½œä¸­'
      };
      setProfile(defaultProfile);
      setCurrentStatus({
        emoji: defaultProfile.current_status_emoji,
        text: defaultProfile.current_status_text
      });
      setLinks([]);
    }
  };

  // å¤„ç†ç™»å½•æˆåŠŸ
  const handleAuthSuccess = (user) => {
    console.log('ç™»å½•æˆåŠŸ:', user);
    setUser(user);
    loadUserData(user.id);
  };

  // å¤„ç†ç™»å‡º
  const handleLogout = async () => {
    try {
      await auth.signOut();
      setUser(null);
      setProfile(null);
      setLinks([]);
      setCurrentStatus({ emoji: 'ğŸ’¼', text: 'å·¥ä½œä¸­' });
      setIsEditMode(false);
      setShowProfileEditor(false);
      setShowLinkManager(false);
      setShowAvatarUploader(false);
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error);
    }
  };

  // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
  const toggleEditMode = () => {
    const newEditMode = !isEditMode;
    setIsEditMode(newEditMode);
    console.log('åˆ‡æ¢ç¼–è¾‘æ¨¡å¼:', newEditMode);
    
    // é€€å‡ºç¼–è¾‘æ¨¡å¼æ—¶å…³é—­æ‰€æœ‰å¼¹çª—
    if (!newEditMode) {
      setShowProfileEditor(false);
      setShowLinkManager(false);
      setShowAvatarUploader(false);
    }
  };

  // é€‰æ‹©çŠ¶æ€
  const selectStatus = async (emoji, text) => {
    console.log('é€‰æ‹©æ–°çŠ¶æ€:', emoji, text);
    const newStatus = { emoji, text };
    
    // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤º
    setCurrentStatus(newStatus);
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    if (user && profile) {
      try {
        console.log('ä¿å­˜çŠ¶æ€åˆ°æ•°æ®åº“...');
        const { data, error } = await database.updateProfile(user.id, {
          current_status_emoji: emoji,
          current_status_text: text
        });
        
        if (error) {
          console.error('ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
        } else {
          console.log('çŠ¶æ€ä¿å­˜æˆåŠŸ:', data);
        }
      } catch (error) {
        console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
      }
    }
  };

  // å¤„ç†èµ„æ–™æ›´æ–°
  const handleProfileUpdate = (updatedProfile) => {
    console.log('èµ„æ–™æ›´æ–°æˆåŠŸ:', updatedProfile);
    setProfile(updatedProfile);
    setCurrentStatus({
      emoji: updatedProfile.current_status_emoji || 'ğŸ’¼',
      text: updatedProfile.current_status_text || 'å·¥ä½œä¸­'
    });
  };

  // å¤„ç†é“¾æ¥æ›´æ–°
  const handleLinksUpdate = (updatedLinks) => {
    console.log('é“¾æ¥æ›´æ–°:', updatedLinks);
    setLinks(updatedLinks);
  };

  // å¤„ç†å¤´åƒæ›´æ–°
  const handleAvatarUpdate = (newAvatarUrl) => {
    console.log('å¤´åƒæ›´æ–°:', newAvatarUrl);
    setProfile(prev => ({ ...prev, avatar_url: newAvatarUrl }));
  };

  console.log('å½“å‰çŠ¶æ€ - loading:', loading, 'user:', user, 'profile:', profile, 'links:', links);

  // åŠ è½½ä¸­çŠ¶æ€
  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-text">åŠ è½½ä¸­...</div>
      </div>
    );
  }

  // æœªç™»å½•æ˜¾ç¤ºè®¤è¯ç•Œé¢
  if (!user) {
    return <Auth onAuthSuccess={handleAuthSuccess} />;
  }

  // å·²ç™»å½•æ˜¾ç¤ºä¸ªäººé¡µé¢
  return (
    <div className="main-container">
      {/* MyPage å“ç‰Œæ ‡è¯† */}
      <div className="brand-header">
        <div className="brand-logo">
          <span className="brand-icon">ğŸ”—</span>
          <span className="brand-name">MyPage</span>
        </div>
      </div>

      {/* ç¼–è¾‘æŒ‰é’® */}
      <button className="toggle-edit" onClick={toggleEditMode}>
        âš™ï¸
      </button>

      {/* ç™»å‡ºæŒ‰é’® */}
      <button className="logout-button" onClick={handleLogout}>
        ğŸšª
      </button>
      
      {/* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */}
      <ThemeToggle />

      <div className="content-card">
        {/* ç¼–è¾‘æ¨¡å¼æç¤º */}
        {isEditMode && (
          <div className="edit-mode">
            <div className="edit-mode-text">
              ç¼–è¾‘æ¨¡å¼å·²å¼€å¯ - ç‚¹å‡»çŠ¶æ€é€‰é¡¹æ¥æ›´æ”¹ä½ çš„å½“å‰çŠ¶æ€
            </div>
            <div className="edit-buttons">
              <button 
                className="edit-profile-button"
                onClick={() => setShowProfileEditor(true)}
              >
                ğŸ“ ç¼–è¾‘ä¸ªäººèµ„æ–™
              </button>
              <button 
                className="edit-links-button"
                onClick={() => setShowLinkManager(true)}
              >
                ğŸ”— ç®¡ç†é“¾æ¥
              </button>
            </div>
          </div>
        )}

        {/* å¤´åƒéƒ¨åˆ† - æ”¯æŒç‚¹å‡»ä¸Šä¼  */}
        <div className="avatar-container">
          <div 
            className="avatar-clickable"
            onClick={() => isEditMode && setShowAvatarUploader(true)}
            style={{ cursor: isEditMode ? 'pointer' : 'default' }}
          >
            {profile?.avatar_url ? (
              <img
                src={profile.avatar_url}
                alt="å¤´åƒ"
                className="avatar-image"
              />
            ) : (
              <div className="avatar-fallback">ğŸ‘¤</div>
            )}
            {/* ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºä¸Šä¼ æç¤º */}
            {isEditMode && (
              <div className="avatar-upload-hint">
                ğŸ“¸ ç‚¹å‡»æ›´æ¢å¤´åƒ
              </div>
            )}
          </div>
          {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
          <div className="status-indicator">{currentStatus.emoji}</div>
        </div>

        <h1 className="user-name">{profile?.display_name || 'æ–°ç”¨æˆ·'}</h1>
        <p className="user-bio">{profile?.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™...'}</p>

        {/* çŠ¶æ€æ˜¾ç¤º */}
        <div className="status-display">
          <span className="status-emoji">{currentStatus.emoji}</span>
          <span className="status-text">{currentStatus.text}</span>
        </div>

        {/* çŠ¶æ€é€‰æ‹©å™¨ */}
        {isEditMode && (
          <div className="status-selector">
            <h3>é€‰æ‹©ä½ çš„çŠ¶æ€</h3>
            <div className="status-options">
              {statusOptions.map((status, index) => (
                <div
                  key={index}
                  className={`status-option ${
                    currentStatus.emoji === status.emoji ? 'active' : ''
                  }`}
                  onClick={() => selectStatus(status.emoji, status.text)}
                >
                  <span>{status.emoji}</span>
                  <span>{status.text}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* é“¾æ¥éƒ¨åˆ† */}
        <div className="links-container">
          {links && links.length > 0 ? (
            links.map((link) => (
              <a
                key={link.id}
                href={link.url}
                target="_blank"
                rel="noopener noreferrer"
                className="link-button"
                style={{
                  display: 'block',
                  padding: '16px 24px',
                  margin: '12px auto',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  textDecoration: 'none',
                  borderRadius: '12px',
                  fontSize: '16px',
                  fontWeight: '600',
                  textAlign: 'center',
                  width: '80%',
                  maxWidth: '300px',
                  transition: 'all 0.3s ease',
                  border: 'none'
                }}
              >
                {link.title}
              </a>
            ))
          ) : (
            <div className="no-links">
              <p>è¿˜æ²¡æœ‰æ·»åŠ é“¾æ¥</p>
              {isEditMode ? (
                <p>ç‚¹å‡»"ğŸ”— ç®¡ç†é“¾æ¥"å¼€å§‹æ·»åŠ </p>
              ) : (
                <p>ç‚¹å‡»è®¾ç½®æŒ‰é’®å¼€å§‹ç¼–è¾‘</p>
              )}
            </div>
          )}
        </div>
      </div>

      {/* ä¸ªäººèµ„æ–™ç¼–è¾‘å™¨å¼¹çª— */}
      {showProfileEditor && (
        <ProfileEditor
          user={user}
          profile={profile}
          onProfileUpdate={handleProfileUpdate}
          onClose={() => setShowProfileEditor(false)}
        />
      )}

      {/* é“¾æ¥ç®¡ç†å™¨å¼¹çª— */}
      {showLinkManager && (
        <LinkManager
          user={user}
          links={links}
          onLinksUpdate={handleLinksUpdate}
          onClose={() => setShowLinkManager(false)}
        />
      )}

      {/* å¤´åƒä¸Šä¼ å¼¹çª— */}
      {showAvatarUploader && (
        <AvatarUploader
          user={user}
          currentAvatarUrl={profile?.avatar_url}
          onAvatarUpdate={handleAvatarUpdate}
          onClose={() => setShowAvatarUploader(false)}
        />
      )}
    </div>
  );
}